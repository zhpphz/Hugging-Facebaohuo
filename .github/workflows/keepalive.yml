name: Keepalive All Hugging Face Spaces
on:
  schedule:
    - cron: "15 1,5,15 * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ping Spaces
        id: ping
        run: |
          error_urls=""
          success_count=0
          total_count=0
          
          while IFS= read -r url; do
            ((total_count++))
            status_code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            echo "URL: $url | 状态码: $status_code"
            
            if [ "$status_code" -ne 200 ]; then
              error_urls="${error_urls}${url} (状态码: ${status_code})\n"
            else
              ((success_count++))
            fi
            sleep 1
          done < urls.txt
          
          # 使用旧版 set-output 语法
          echo "::set-output name=error_urls::${error_urls}"
          echo "::set-output name=has_errors::$( [ -n "$error_urls" ] && echo true || echo false )"
          echo "::set-output name=success_count::${success_count}"
          echo "::set-output name=total_count::${total_count}"

      - name: Send WxPusher Notification
        if: always()
        run: |
          WXPUSHER_TOKEN="AT_8W0HaJDqsTjYPxgsyCdg5xxGU58e7a9q"
          UIDS="UID_pT7ifPmHs5ewHZcNXE9saeXCCopf"
          
          # 处理换行符（确保 JSON 格式正确）
          ERROR_URLS="${{ steps.ping.outputs.error_urls }}"
          ERROR_URLS_ESCAPED=$(echo "${ERROR_URLS}" | sed 's/\\n/%0A/g')  # 替换 \n 为 URL 编码的换行符
          
          if ${{ steps.ping.outputs.has_errors == 'true' }}; then
            message="⚠️ Hugging Face Spaces检测异常%0A%0A异常链接:%0A${ERROR_URLS_ESCAPED}%0A%0A成功: ${{ steps.ping.outputs.success_count }}/${{ steps.ping.outputs.total_count }}"
          else
            message="✅ 所有链接正常%0A检测总数: ${{ steps.ping.outputs.total_count }}"
          fi
          
          curl -X POST \
            "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "'"${WXPUSHER_TOKEN}"'",
              "content": "'"${message}"'",
              "uids": ["'"${UIDS}"'"]
            }'
